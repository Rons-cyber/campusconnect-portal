<script>
let currentRole = '';
let chatMessages = JSON.parse(localStorage.getItem('chatMessages')) || [];
let issues = JSON.parse(localStorage.getItem('issues')) || [];

function openMenu() { document.getElementById("sidebar").style.width = "240px"; }
function closeMenu() { document.getElementById("sidebar").style.width = "0"; }
function showSection(id) {
  document.querySelectorAll('main section').forEach(sec => sec.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  closeMenu();
}

// Restore session if exists
window.onload = () => {
  const savedName = localStorage.getItem('name');
  const savedRole = localStorage.getItem('role');
  if (savedName && savedRole) {
    currentRole = savedRole;
    document.getElementById('name').value = savedName;
    document.getElementById('role').value = savedRole;
    document.getElementById('welcomeMsg').innerText = `Welcome ${savedName}! You are logged in as ${savedRole}.`;
    toggleAdminButtons(savedRole);
  }
  renderChat();
  renderIssues();
  document.getElementById("facultyList").innerHTML = localStorage.getItem("facultyList") || "";
  document.getElementById("alumniList").innerHTML = localStorage.getItem("alumniList") || "";
  document.getElementById("tournamentList").innerHTML = localStorage.getItem("tournamentList") || "";
};

// Login
function login() {
  const name = document.getElementById('name').value.trim();
  const role = document.getElementById('role').value;
  if (!name) return alert('Please enter your name');
  currentRole = role;
  document.getElementById('welcomeMsg').innerText = `Welcome ${name}! You are logged in as ${role}.`;

  localStorage.setItem('name', name);
  localStorage.setItem('role', role);

  toggleAdminButtons(role);
  renderIssues();
}

function toggleAdminButtons(role) {
  ['addFacultyBtn','addAlumniBtn','addTournamentBtn'].forEach(id => {
    document.getElementById(id).classList.toggle('hidden', role !== 'admin');
  });
}

// Chat
function sendMessage() {
  const msg = document.getElementById('chatInput').value.trim();
  if (!msg) return;
  const name = localStorage.getItem('name') || 'Guest';
  chatMessages.push({name, msg});
  localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
  document.getElementById('chatInput').value = '';
  renderChat();
}
function renderChat() {
  const box = document.getElementById('chatBox');
  box.innerHTML = chatMessages.map(c => `<div class="chat-message"><b>${c.name}:</b> ${c.msg}</div>`).join('');
  box.scrollTop = box.scrollHeight;
}

// Issues
function addIssue() {
  const issueText = document.getElementById('issueText').value.trim();
  if (!issueText) return alert('Please describe your issue!');
  const name = localStorage.getItem('name') || 'Anonymous';
  const role = localStorage.getItem('role') || 'Guest';
  const issueObj = { name, role, text: issueText, resolved: false };
  issues.push(issueObj);
  localStorage.setItem('issues', JSON.stringify(issues));
  document.getElementById('issueText').value = '';
  renderIssues();
}

function renderIssues() {
  const issueList = document.getElementById('issueList');
  if (!issues.length) {
    issueList.innerHTML = `<p>No issues submitted yet.</p>`;
    return;
  }
  
  issueList.innerHTML = issues.map((i, idx) => {
    const resolvedClass = i.resolved ? "background:#e5e7eb; color:#6b7280; text-decoration:line-through;" : "";
    const adminControls = currentRole === 'admin'
      ? `<div style="margin-top:5px;">
           <button onclick="resolveIssue(${idx})" style="background:#22c55e;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">âœ… Resolve</button>
           <button onclick="deleteIssue(${idx})" style="background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">ðŸ—‘ Delete</button>
         </div>` 
      : "";
    
    return `<div class="list-item" style="${resolvedClass}">
              <b>${i.name}</b> <small style="color:gray;">(${i.role})</small><br>
              ${i.text}
              ${i.resolved ? "<br><small>[Resolved]</small>" : ""}
              ${adminControls}
            </div>`;
  }).join('');
}

function resolveIssue(index) {
  if (!confirm("Mark this issue as resolved?")) return;
  issues[index].resolved = true;
  localStorage.setItem('issues', JSON.stringify(issues));
  renderIssues();
}

function deleteIssue(index) {
  if (!confirm("Are you sure you want to delete this issue?")) return;
  issues.splice(index, 1);
  localStorage.setItem('issues', JSON.stringify(issues));
  renderIssues();
}

// CGPA
function addSubject() {
  const div = document.createElement('div');
  div.innerHTML = `
    <input type="number" placeholder="Credits" class="credit">
    <input type="number" placeholder="Grade (0-10)" class="grade">
  `;
  document.getElementById('subjects').appendChild(div);
}
function calculateCGPA() {
  const credits = [...document.querySelectorAll('.credit')].map(i => parseFloat(i.value)||0);
  const grades = [...document.querySelectorAll('.grade')].map(i => parseFloat(i.value)||0);
  const totalCredits = credits.reduce((a,b)=>a+b,0);
  const totalPoints = credits.map((c,i)=>c*grades[i]).reduce((a,b)=>a+b,0);
  const cgpa = totalCredits ? (totalPoints/totalCredits).toFixed(2) : 0;
  document.getElementById('cgpaResult').innerText = `Your CGPA is ${cgpa}`;
}

// Admin-only additions (with storage)
function addFaculty() {
  const name = prompt("Enter Faculty Name:");
  const dept = prompt("Enter Department:");
  if (name && dept) {
    const item = `<div class='list-item'><b>${name}</b> - ${dept}</div>`;
    document.getElementById("facultyList").innerHTML += item;
    localStorage.setItem("facultyList", document.getElementById("facultyList").innerHTML);
  }
}
function addAlumni() {
  const name = prompt("Enter Alumni Name:");
  const year = prompt("Enter Graduation Year:");
  if (name && year) {
    const item = `<div class='list-item'><b>${name}</b> - Class of ${year}</div>`;
    document.getElementById("alumniList").innerHTML += item;
    localStorage.setItem("alumniList", document.getElementById("alumniList").innerHTML);
  }
}
function addTournament() {
  const name = prompt("Enter Tournament Name:");
  const date = prompt("Enter Tournament Date:");
  if (name && date) {
    const item = `<div class='list-item'><b>${name}</b> - ${date}</div>`;
    document.getElementById("tournamentList").innerHTML += item;
    localStorage.setItem("tournamentList", document.getElementById("tournamentList").innerHTML);
  }
}
</script>
